DROP TABLE CDP_D.CDP_STG.FIRST_32_COLUMNS;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.FIRST_32_COLUMNS AS
SELECT DISTINCT 
CUST_PROFILE.CONTACT_ID
,CUST_PROFILE.BIRTHDAY
,CUST_PROFILE.AGE
,(CASE WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 1 AND 18 THEN '0-18'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 19 AND 24 THEN '19-24'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 25 AND 34 THEN '25-34'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 35 AND 44 THEN '35-44'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 45 AND 54 THEN '45-54'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 55 AND 64 THEN '55-54'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) BETWEEN 65 AND 74 THEN '65-74'
  WHEN DATEDIFF('YEAR',SYSDATE(),INFO.BIRTHDAY) >=75  THEN '75+'
  ELSE 'Unknown' END) AS AGE_BUCKET
,CUST_PROFILE.GENDER_CD
,CUST_PROFILE.FIRST_NAM
,CUST_PROFILE.LAST_NAM
,CUST_PROFILE.ADDRESS1
,CUST_PROFILE.ADDRESS2
,CUST_PROFILE.ADDRESS3
,CUST_PROFILE.CITY
,CUST_PROFILE.ZIP_CD
,CUST_PROFILE.STATE
,CUST_PROFILE.COUNTRY
,EMAIL1.EMAIL_ADDRESS
,EMAIL1.IS_OPT_OUT_CD AS IS_OPT_OUT_CD
,EMAIL1.IS_SHARED_EMAIL_CD
,EMAIL1.IS_EMARKETABLE_CD AS IS_EMAIL1_EMARKETABLE_CD
,EMAIL2.EMAIL_ADDRESS AS EMAIL_ADDRESS_2
,EMAIL2.IS_OPT_OUT_CD AS IS_OPT_OUT_CD_2
,EMAIL2.IS_SHARED_EMAIL_CD AS IS_SHARED_EMAIL_CD_2
,EMAIL2.IS_EMARKETABLE_CD AS IS_EMAIL2_EMARKETABLE_CD
,EMAIL3.EMAIL_ADDRESS AS EMAIL_ADDRESS_3
,EMAIL3.IS_OPT_OUT_CD AS IS_OPT_OUT_CD_3
,EMAIL3.IS_SHARED_EMAIL_CD  IS_SHARED_EMAIL_CD_3
,EMAIL3.IS_EMARKETABLE_CD AS IS_EMAIL3_EMARKETABLE_CD
,INFO.PRIMARY_PHONE_NBR
,INFO.SECONDARY_PHONE_NBR
,INFO.THIRD_PHONE_NBR
,INFO.TARGET_NET_WORTH
,FCM.IS_MARKETABLE_CD
,FCM.IS_DM_MARKETABLE_CD
,FCM.IS_EM_MARKETABLE_CD
,CASE WHEN CUST_PROFILE.LAST_BOOKING_CURVE_DAYS_CNT < 90 THEN 'late'
      WHEN CUST_PROFILE.LAST_BOOKING_CURVE_DAYS_CNT BETWEEN 90 AND 180 THEN 'Peak'
      WHEN CUST_PROFILE.LAST_BOOKING_CURVE_DAYS_CNT BETWEEN 180 AND 270 THEN 'Early'
      WHEN CUST_PROFILE.LAST_BOOKING_CURVE_DAYS_CNT >270 THEN 'Super Early'
 ELSE NULL END AS BOOKING_CURVE_SEGMENT
,CASE WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE >90 THEN '0-3 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 90 AND 180 THEN '3-6 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 180 AND 270 THEN '6-9 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 270 AND 360 THEN '9-12 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 360 AND 450 THEN '12-15 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 450 AND 540 THEN '15-18 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 540 AND 630 THEN '18-21 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE BETWEEN 630 AND 720 THEN '21-24 Months'
      WHEN TRANS.CONTACT_ID IS NULL AND CUST_PROFILE.TENURE > 720 THEN '24+ Months'
      END AS TENURE
,CUST_PROFILE.DMA_CD
,CASE WHEN FCM.IS_FUTURE_BOOKED_CD = 'Y' THEN 'F' ELSE 'P' END AS CUSTOMER_SEGMENT
,FCM.IS_FUTURE_BOOKED_CD
,DISTRICT.SALES_CHANNEL_CD
,INFO.IS_PCC_ASSIGNED_CD AS IS_PCC_CD
,LEAD.LEAD_SOURCE_CD
,CASE WHEN CUST_PROFILE.IS_EVER_TRAVELED_W_CHILDREN_CD = 'Y' THEN 'Y' ELSE 'N' END AS FAMILY_FLAG
,CUST_PROFILE.LAST_SAIL_TOTAL_SPEND_AMT
,REGION.REGION_NAM
,LOYALTY.LOYALTY_LEVEL
,LEVEL_BRIDGE.LOYALTY_CREDITS
,CUST_PROFILE.SAIL_TOTAL_CRUISES_CNT
,CUST_PROFILE.LAST_SAIL_BOOKING_CHANNEL
,CUST_PROFILE.COMPETING_CRUISER_GSS
,CASE WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL < 365 THEN '1-2Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 365 AND 730 THEN '2-3Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 730 AND 1095 THEN '3-4Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 1095 AND 1460 THEN '4-5Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 1460 AND 1825 THEN '5-6Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 1825 AND 2190 THEN '6-7Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL BETWEEN 2190 AND 2555 THEN '7-8Yr'
      WHEN CUST_PROFILE.DAYS_SINCE_LAST_SAIL > 2555 THEN '8+yr'
 ELSE NULL END AS SAIL_RECENCY_SEGMENT
,CUST_PROFILE.GENERATION_SEGMENT
,CUST_PROFILE.CRUISE_NEXT_COUNT
,INFO.TARGET_NARROW_BAND_INCOME

FROM "CDP_D"."APP_CDP_AGGR"."CUSTOMER_360_PROFILE" CUST_PROFILE -- 87096835
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.FACT_TRANS_MASTER
                 QUALIFY ROW_NUMBER() OVER( PARTITION BY CONTACT_ID ORDER BY ETL_PROCESS_TS DESC)=1)TRANS
ON CUST_PROFILE.CONTACT_ID = TRANS.CONTACT_ID
AND CUST_PROFILE.BRAND_CD = TRANS.BRAND_CD -- 87096835
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_CONTACT_INFO INFO
ON CUST_PROFILE.CONTACT_ID = INFO.CONTACT_ID -- 87096835
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_CONTACT_MASTER FCM
ON CUST_PROFILE.CONTACT_ID = FCM.CONTACT_ID -- 87096835
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.DIM_CONTACT_EMAIL_ADDRESS
                 WHERE IS_ACTIVE_CD=1 
                 AND IS_INVALID_EMAIL_CD='N'
                 AND EMAIL_RANKING = 1
                )EMAIL1
ON CUST_PROFILE.CONTACT_ID = EMAIL1.CONTACT_ID
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.DIM_CONTACT_EMAIL_ADDRESS
                 WHERE IS_ACTIVE_CD=1 
                 AND IS_INVALID_EMAIL_CD='N'
                 AND EMAIL_RANKING = 2
                )EMAIL2
ON CUST_PROFILE.CONTACT_ID = EMAIL2.CONTACT_ID
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.DIM_CONTACT_EMAIL_ADDRESS
                 WHERE IS_ACTIVE_CD=1 
                 AND IS_INVALID_EMAIL_CD='N'
                 AND EMAIL_RANKING = 3
                )EMAIL3
ON CUST_PROFILE.CONTACT_ID = EMAIL3.CONTACT_ID
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_AGENT_MASTER AGENT
ON TRANS.AGENT_ID = AGENT.AGENT_ID
AND TRANS.BRAND_CD = AGENT.BRAND_CD
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_AGENCY_MASTER AGENCY
ON AGENT.AGENCY_ID = AGENCY.AGENCY_ID
AND AGENT.BRAND_CD = AGENCY.BRAND_CD
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.DIM_LEAD
                 QUALIFY ROW_NUMBER() OVER(PARTITION BY CONTACT_ID ORDER BY ETL_PROCESS_TS)=1) LEAD 
ON CUST_PROFILE.CONTACT_ID = LEAD.CONTACT_ID
AND CUST_PROFILE.BRAND_CD = LEAD.BRAND_CD
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_GUEST_DISTRICT_MASTER DISTRICT
ON AGENCY.DISTRICT_MASTER_SUR_KEY = DISTRICT.DISTRICT_MASTER_SUR_KEY
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.CONTACT_ADDRESS_BRIDGE WHERE IS_MASTER_ADDRESS_CD = 'Y' AND IS_ACTIVE_CD=1) ADD_BRIDGE
ON CUST_PROFILE.CONTACT_ID = ADD_BRIDGE.CONTACT_ID
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_ADDRESS ADDRESS
ON ADD_BRIDGE.ADDRESS_ID = ADDRESS.ADDRESS_ID
LEFT OUTER JOIN "CDP_D"."APP_CDP"."DIM_COUNTRY_REGION" REGION
ON ADDRESS.COUNTRY_ID = REGION.COUNTRY_ID
LEFT OUTER JOIN "CDP_D"."APP_CDP"."CONTACT_LOYALTY_LEVEL_BRIDGE" LEVEL_BRIDGE
ON INFO.CONTACT_ID = LEVEL_BRIDGE.CONTACT_ID
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.DIM_LOYALTY_LEVEL WHERE BRAND_CD = 'NCL') LOYALTY
ON LEVEL_BRIDGE.LOYALTY_LEVEL_SUR_KEY = LOYALTY.LOYALTY_LEVEL_SUR_KEY

WHERE CUST_PROFILE.BRAND_CD = 'NCL'
AND CUST_PROFILE.REGION = 'UK'
AND FCM.IS_MARKETABLE_CD = 'Y'
AND CUST_PROFILE.IS_DO_NOT_SELL_CD <> 'Y'
AND CUST_PROFILE.AGE BETWEEN 7 AND 108 
AND CUST_PROFILE.ADDRESS_ID <> '0'
AND TRANS.CONTACT_ID <> '0'
AND EMAIL1.IS_EMARKETABLE_CD IN ('Y','N')
AND EMAIL2.IS_EMARKETABLE_CD IN ('Y','N')
AND EMAIL3.IS_EMARKETABLE_CD IN ('Y','N')
--AND AGENCY.PRIMARY_PHONE_NBR <> INFO.PRIMARY_PHONE_NBR
--AND AGENCY.PRIMARY_PHONE_NBR <> INFO.SECONDARY_PHONE_NBR
--AND AGENCY.PRIMARY_PHONE_NBR <> INFO.THIRD_PHONE_NBR

;

DROP TABLE CDP_D.CDP_STG.BOOKED_LAST_5_YEARS;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.BOOKED_LAST_5_YEARS AS
SELECT DISTINCT CUST_PROFILE.CONTACT_ID
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='BLISS' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_BLISS_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='ENCORE' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_ENCORE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JOY' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_JOY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SKY' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_SKY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SUN' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_SUN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='PRIDE AMER' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS "EVER_BOOKED_PRIDE-OF-AMERICA_LAST5_YEARS"
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='BREAKAWAY' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_BREAKAWAY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='DAWN' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_DAWN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='EPIC' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_EPIC_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='ESCAPE' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_ESCAPE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='GEM' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_GEM_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='GETAWAY' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_GETAWAY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JADE' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_JADE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JEWEL' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_JEWEL_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='PEARL' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_PEARL_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SPIRIT' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_SPIRIT_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='STAR' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_BOOKED_STAR_LAST5_YEARS
FROM "CDP_D"."APP_CDP_AGGR"."CUSTOMER_360_PROFILE" CUST_PROFILE
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_TRANS_MASTER TRANS
ON CUST_PROFILE.CONTACT_ID = TRANS.CONTACT_ID
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_GUEST_BOOKING GUEST
ON TRANS.TRANS_MASTER_SUR_KEY = GUEST.TRANS_MASTER_SUR_KEY
WHERE TRANS.BOOKED_DAT BETWEEN DATEADD('YEAR',-5,CURRENT_DATE) AND CURRENT_DATE
AND TRANS.BRAND_CD IN ('NCL')
AND CUST_PROFILE.BRAND_CD = 'NCL'
AND CUST_PROFILE.REGION = 'UK'
--AND FCM.IS_MARKETABLE_CD = 'Y'
AND CUST_PROFILE.IS_DO_NOT_SELL_CD <> 'Y'
AND CUST_PROFILE.AGE BETWEEN 7 AND 108 
AND CUST_PROFILE.ADDRESS_ID <> '0'
AND TRANS.CONTACT_ID <> '0'
GROUP BY 1;

DROP TABLE CDP_D.CDP_STG.SAILED_LAST_5_YEARS;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.SAILED_LAST_5_YEARS AS
SELECT
CUST_PROFILE.CONTACT_ID
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='BLISS' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_BLISS_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='ENCORE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_ENCORE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JOY' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_JOY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SKY' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_SKY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SUN' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_SUN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='PRIDE AMER' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS "EVER_SAIL_PRIDE-OF-AMERICA_LAST5_YEARS"
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='BREAKAWAY' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_BREAKAWAY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='DAWN' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_DAWN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='EPIC' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0  THEN 'Y' ELSE 'N' END AS EVER_SAIL_EPIC_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='ESCAPE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_ESCAPE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='GEM' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_GEM_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='GETAWAY' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_GETAWAY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JADE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_JADE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='JEWEL' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_JEWEL_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='PEARL' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_PEARL_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='SPIRIT' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_SPIRIT_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD)))='STAR' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_STAR_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='ALASKA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_ALASKA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='BAHAMAS' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_BAHAMAS_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='BERMUDA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_BERMUDA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='CANADA & NEW ENGLAND' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_CANENG_IND_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='CARIBBEAN' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_CARIBBEAN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='CUBA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_CUBA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='EUROPE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_EUROPE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='HAWAII' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_HAWAII_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='MEXICAN RIVIERA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_MEXICAN_RIVIERA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='MIAMI' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_MIAMI_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='SOUTH AMERICA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_SOUTH_AMERICA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='REPOSITIONS' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_REPOSITION_LAST5_YEARS
,MAX(TRANS.CRUISE_SAIL_ID) AS EVER_SAIL_INSIDE_REPOSITIONS_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='INSIDE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_INSIDE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='OUTSIDE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_OUTSIDE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='HAVEN' AND TRANS.RES_STATUS_TYPE_CD='CX'  THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_HAVEN_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='BALCONY' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_BALCONY_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='MINISUITE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_MINISUITE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='ONETWO' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_ONETWO_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.BOOKED_META_CATEGORY_NAM)))='SUITE' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_SUITE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.BOOKED_META_CATEGORY_NAM)))='STUDIO' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_STUDIO_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.BOOKED_META_CATEGORY_NAM)))IN ('SUITE','CONCIERGE') AND upper(TRIM((GUEST.BOOKED_CATEGORY_CD))) IN ('A2','A3', 'A4', 'A5', 'A6', 'A7', 'AA', 'AB', 'AC', 'AD', 'AE', 'AH', 'AJ', 'CA', 'CB', 'CC', 'CD', 'CE', 'CF', 'CG', 'CH', 'CI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'H7', 'H8' ,'H9', 'HA', 'HB', 'HC', 'HD', 'HE', 'HF', 'HG', 'HH', 'HI', 'HJ', 'HS', 'S1'
                                                                                                                                 , 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8', 'S9', 'SA', 'SB', 'SC', 'SD', 'SE', 'SF', 'SG','SH', 'SI', 'SJ', 'SK', 'SL', 'SM', 'SN','SP', 'SQ')
           AND upper(TRIM((GUEST.IS_PSEUDO_CATEGORY_CD))) = 'N' AND upper(TRIM((GUEST.IS_MANDATORY_ASSIGNMENT_CD))) = 'Y' /*AND upper(TRIM((GUEST.CATEGORY_CD))) IN ('CA','CB','CC','CF') */
           AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAIL_JOY_CONCIERGE_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC)))='AAASIA' AND TRANS.RES_STATUS_TYPE_CD='CX' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS EVER_SAILED_ASIA_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((PROMO.PROMO_CD))) = 'SAILAWAY' AND TRANS.BOOKED_DAT <> '1900-01-01' AND TRANS.GUEST_CANCELLED_DAT <> '1900-01-01' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_Sailaway_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.EMBARK_PORT_CD))) = 'NYC' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_from_New_York_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.EMBARK_PORT_CD))) = 'BOS' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_from_Boston_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((TRANS.SHIP_CD))) = 'BLISS' AND upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC))) IN ('CRBNYC','CRBMIA') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Booked_Bliss_Caribbean_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN TRANS.EMBARK_PORT_CD= 'MIA' AND TRANS.SAIL_DAY_QTY >=3 AND TRANS.SAIL_DAY_QTY <=5 THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_from_Miami_3_4_5_nights
,CASE WHEN SUM(CASE WHEN TRANS.EMBARK_PORT_CD= 'MIA' AND TRANS.SAIL_DAY_QTY >=6 THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_from_Miami_6_nights_plus
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC))) IN ('AlBAHALL', 'BAHAM2', 'BAHAM3',  'BAHAM4',  'BAHAMA',  'BAHANY', 'L120', 'CARALL', 'CRBGLF', 'CRBMIA', 'CRBNYC', 'CRBOTR', 'CRBTPA', 'ECARIB', 'MEXRIV',  'SCARIB',  'WCAR-5', 'WCARIB') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_3_1_4_30_Mex_Riv_Bahamas_Caribbean_LAST5_YEARS
,CASE WHEN SUM(CASE WHEN upper(TRIM((GUEST.RM_ROLLUP_PRODUCT_DESC))) IN ('AlBAHALL', 'BAHAM2', 'BAHAM3',  'BAHAM4',  'BAHAMA',  'BAHANY', 'L120', 'CARALL', 'CRBGLF', 'CRBMIA', 'CRBNYC', 'CRBOTR', 'CRBTPA', 'ECARIB', 'MEXRIV',  'SCARIB',  'WCAR-5', 'WCARIB') AND CUST_PROFILE.IS_EVER_TRAVELED_W_CHILDREN_CD = 'Y' THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS Ever_Sailed_3_1_4_30_Mex_Riv_Bahamas_Caribbean_With_Kids_LAST5_YEARS

FROM "CDP_D"."APP_CDP_AGGR"."CUSTOMER_360_PROFILE" CUST_PROFILE
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_TRANS_MASTER TRANS
ON CUST_PROFILE.CONTACT_ID = TRANS.CONTACT_ID
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_GUEST_BOOKING GUEST
ON TRANS.TRANS_MASTER_SUR_KEY = GUEST.TRANS_MASTER_SUR_KEY
LEFT OUTER JOIN "CDP_D"."APP_CDP"."GUEST_ONBOARD_PROMO_BRIDGE" BRIDGE
ON TRANS.TRANS_MASTER_SUR_KEY = BRIDGE.TRANS_MASTER_SUR_KEY
LEFT OUTER JOIN "CDP_D"."APP_CDP"."DIM_GUEST_ONBOARD_PROMO" PROMO
ON BRIDGE.GUEST_ONBOARD_PROMO_SUR_KEY = PROMO.GUEST_ONBOARD_PROMO_SUR_KEY
WHERE TRANS.SAIL_DAT BETWEEN DATEADD('YEAR',-5,CURRENT_DATE) AND CURRENT_DATE
AND TRANS.BRAND_CD IN ('NCL')
AND CUST_PROFILE.BRAND_CD = 'NCL'
AND CUST_PROFILE.REGION = 'UK'
--AND FCM.IS_MARKETABLE_CD = 'Y'
AND CUST_PROFILE.IS_DO_NOT_SELL_CD <> 'Y'
AND CUST_PROFILE.AGE BETWEEN 7 AND 108 
AND CUST_PROFILE.ADDRESS_ID <> '0'
AND TRANS.CONTACT_ID <> '0'
GROUP BY 1;

DROP TABLE CDP_D.CDP_STG.COLUMN_126_ONWARDS;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.COLUMN_126_ONWARDS AS 
SELECT 
CUST_PROFILE.CONTACT_ID
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('HWTR','HNLD') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Hawaii
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('HWTR','HNLD') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Hawaii
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('WCMA','WCNR','WCNY','WOTH','WTPA','WCFB') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Western_Caribbean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('WCMA','WCNR','WCNY','WOTH','WTPA','WCFB') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Western_Caribbean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('ECMA','EOTH','ETPA') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Eestern_Caribbean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('ECMA','EOTH','ETPA') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Eestern_Caribbean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('MBCN','MCCN','CMED','MHLY','MEGK','GIEJ','MGKI','GIIT','IGMJ','GIAE','ISFR') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Europe_Mediterranean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('MBCN','MCCN','CMED','MHLY','MEGK','GIEJ','MGKI','GIIT','IGMJ','GIAE','ISFR') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Europe_Mediterranean
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('BLTC','RASU') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Europe_Baltic
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('BLTC','RASU') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Europe_Baltic
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('EUCA','EUBI','EUNF','EUIC','INMF','NASS','BIHC') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Europe_Northern
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('EUCA','EUBI','EUNF','EUIC','INMF','NASS','BIHC') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Europe_Northern
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('AVAN','AKTR','ASEA','AWIT','AYVR') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Alaska
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('AVAN','AKTR','ASEA','AWIT','AYVR') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Alaska
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,7,CURRENT_DATE) AND DATEADD(DAY,120,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('AAASIA') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_7_120_Days_sail_Asia
,CASE WHEN SUM(CASE WHEN TRANS.SAIL_DAT BETWEEN DATEADD(DAY,121,CURRENT_DATE) AND DATEADD(DAY,180,CURRENT_DATE) AND TRANS.SAIL_PRODUCT_CD IN ('AAASIA') THEN 1 ELSE 0 END )>0 THEN 'Y' ELSE 'N' END AS BG_121_180_Days_sail_Asia

FROM "CDP_D"."APP_CDP_AGGR"."CUSTOMER_360_PROFILE" CUST_PROFILE
LEFT OUTER JOIN CDP_D.APP_CDP.FACT_TRANS_MASTER TRANS
ON CUST_PROFILE.CONTACT_ID = TRANS.CONTACT_ID 
WHERE CUST_PROFILE.BRAND_CD = 'NCL'
AND CUST_PROFILE.REGION = 'UK'
--AND FCM.IS_MARKETABLE_CD = 'Y'
AND CUST_PROFILE.IS_DO_NOT_SELL_CD <> 'Y'
AND CUST_PROFILE.AGE BETWEEN 7 AND 108 
AND CUST_PROFILE.ADDRESS_ID <> '0'
AND TRANS.CONTACT_ID <> '0'
GROUP BY 1;

DROP TABLE CDP_D.CDP_STG.PROMO_CD;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.PROMO_CD AS 
SELECT
CUST_PROFILE.CONTACT_ID
,CASE WHEN SUM(CASE WHEN PROMO.IS_OBC_CD = 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_OBC_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_DINING_PACKAGE_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_DINING_PACKAGE_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_DINING_CREDIT_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_DINING_CREDIT_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_BEVERAGE_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_BEVERAGE_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_SODA_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_SODA_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_SERVICE_CHARGE_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_SERVICE_CHARGES_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_AIR_CREDIT_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_AIR_CREDIT_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_SHOREX_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_SHOREX_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_INTERNET_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_INTERNET_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_FREE_HOTEL_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_FREE_HOTEL_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_PHOTOS_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_PHOTOS_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_ARCADE_CREDIT_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_ARCADE_CREDIT_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_CASINO_CREDIT_CD = 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_CASINO_CREDIT_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_THIRD_FOURTH_GUEST_FREE_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_THIRD_FOURTH_GUEST_FREE_CD
,CASE WHEN SUM(CASE WHEN PROMO.IS_THIRD_FOURTH_GUEST_99_USD_CD= 'Y' THEN 1 ELSE 0 END)>1 THEN 'Y' ELSE 'N' END AS IS_THIRD_FOURTH_GUEST_99_USD_CD

FROM "CDP_D"."APP_CDP_AGGR"."CUSTOMER_360_PROFILE" CUST_PROFILE -- 87096835
LEFT OUTER JOIN (SELECT * FROM CDP_D.APP_CDP.FACT_TRANS_MASTER
                 QUALIFY ROW_NUMBER() OVER( PARTITION BY CONTACT_ID ORDER BY ETL_PROCESS_TS DESC)=1)TRANS
ON CUST_PROFILE.CONTACT_ID = TRANS.CONTACT_ID
AND CUST_PROFILE.BRAND_CD = TRANS.BRAND_CD -- 87096835
LEFT OUTER JOIN "CDP_D"."APP_CDP"."GUEST_ONBOARD_PROMO_BRIDGE" BRIDGE
ON TRANS.TRANS_MASTER_SUR_KEY = BRIDGE.TRANS_MASTER_SUR_KEY
LEFT OUTER JOIN "CDP_D"."APP_CDP"."DIM_GUEST_ONBOARD_PROMO" PROMO
ON BRIDGE.GUEST_ONBOARD_PROMO_SUR_KEY = PROMO.GUEST_ONBOARD_PROMO_SUR_KEY
WHERE CUST_PROFILE.BRAND_CD = 'NCL'
AND CUST_PROFILE.REGION = 'UK'
--AND FCM.IS_MARKETABLE_CD = 'Y'
AND CUST_PROFILE.IS_DO_NOT_SELL_CD <> 'Y'
AND CUST_PROFILE.AGE BETWEEN 7 AND 108 
AND CUST_PROFILE.ADDRESS_ID <> '0'
AND TRANS.CONTACT_ID <> '0'
GROUP BY 1

DROP TABLE CDP_D.CDP_STG.STG_UK_WEEKLY_CONTACT_LIVERAMP_INFO;
CREATE OR REPLACE TABLE CDP_D.CDP_STG.STG_UK_WEEKLY_CONTACT_LIVERAMP_INFO AS
SELECT 
nvl(A.CONTACT_ID,'') AS CONTACT_ID
,nvl(FIRST_NAM,'') AS FIRST_NAM
,nvl(LAST_NAM,'') AS LAST_NAM
,nvl(ADDRESS1,'') AS ADDRESS1
,nvl(ADDRESS2,'') AS ADDRESS2
,nvl(ADDRESS2,'') AS ADDRESS3
,'' AS ADDRESS4
,nvl(CITY,'') AS CITY
,nvl(ZIP_CD,'') AS ZIP_CD
,nvl(EMAIL_ADDRESS,'') AS EMAIL_ADDRESS
,nvl(EMAIL_ADDRESS_2,'') AS EMAIL_ADDRESS_2
,nvl(EMAIL_ADDRESS_3,'') AS EMAIL_ADDRESS_3
,nvl(PRIMARY_PHONE_NBR,'') AS PRIMARY_PHONE_NBR
,nvl(SECONDARY_PHONE_NBR,'') AS SECONDARY_PHONE_NBR
,nvl(THIRD_PHONE_NBR,'') AS THIRD_PHONE_NBR
,nvl(AGE,0) AS AGE
,nvl(AGE_BUCKET,'') AS AGE_BUCKET
,nvl(GENDER_CD,'') AS GENDER_CD
,nvl(COUNTRY,'') AS COUNTRY
,nvl(IS_SHARED_EMAIL_CD,'') AS IS_SHARED_EMAIL_CD
,nvl(IS_SHARED_EMAIL_CD_2,'') AS IS_SHARED_EMAIL_CD_2
,nvl(IS_SHARED_EMAIL_CD_3,'') AS IS_SHARED_EMAIL_CD_3
,nvl(TARGET_NET_WORTH,'') AS TARGET_NET_WORTH
,nvl(IS_MARKETABLE_CD,'') AS IS_MARKETABLE_CD
,nvl(IS_DM_MARKETABLE_CD,'') AS IS_DM_MARKETABLE_CD
,nvl(IS_EM_MARKETABLE_CD,'') AS IS_EM_MARKETABLE_CD
,nvl(EVER_BOOKED_BLISS_LAST5_YEARS,'N') AS EVER_BOOKED_BLISS_LAST5_YEARS
,nvl(EVER_SAIL_BLISS_LAST5_YEARS,'N') AS EVER_SAILED_BLISS_LAST5_YEARS
,nvl(EVER_BOOKED_ENCORE_LAST5_YEARS,'N') AS EVER_BOOKED_ENCORE_LAST5_YEARS
,nvl(EVER_SAIL_ENCORE_LAST5_YEARS,'N') AS EVER_SAILED_ENCORE_LAST5_YEARS
,nvl(EVER_BOOKED_JOY_LAST5_YEARS,'N') AS EVER_BOOKED_JOY_LAST5_YEARS
,nvl(EVER_SAIL_JOY_LAST5_YEARS,'N') AS EVER_SAILED_JOY_LAST5_YEARS
,nvl(EVER_BOOKED_SKY_LAST5_YEARS,'N') AS EVER_BOOKED_SKY_LAST5_YEARS
,nvl(EVER_SAIL_SKY_LAST5_YEARS,'N') AS EVER_SAILED_SKY_LAST5_YEARS
,nvl(EVER_BOOKED_SUN_LAST5_YEARS,'N') AS EVER_BOOKED_SUN_LAST5_YEARS
,nvl(EVER_SAIL_SUN_LAST5_YEARS,'N') AS EVER_SAILED_SUN_LAST5_YEARS
,nvl("EVER_BOOKED_PRIDE-OF-AMERICA_LAST5_YEARS",'N') AS "EVER_BOOKED_PRIDE-OF-AMERICA_LAST5_YEARS"
,nvl("EVER_SAIL_PRIDE-OF-AMERICA_LAST5_YEARS",'N') AS "EVER_SAILED_PRIDE-OF-AMERICA_LAST5_YEARS"
,nvl(EVER_BOOKED_BREAKAWAY_LAST5_YEARS,'N') AS EVER_BOOKED_BREAKAWAY_LAST5_YEARS
,nvl(EVER_SAIL_BREAKAWAY_LAST5_YEARS,'N') AS EVER_SAILED_BREAKAWAY_LAST5_YEARS
,nvl(EVER_BOOKED_DAWN_LAST5_YEARS,'N') AS EVER_BOOKED_DAWN_LAST5_YEARS
,nvl(EVER_SAIL_DAWN_LAST5_YEARS,'N') AS EVER_SAILED_DAWN_LAST5_YEARS
,nvl(EVER_BOOKED_EPIC_LAST5_YEARS,'N') AS EVER_BOOKED_EPIC_LAST5_YEARS
,nvl(EVER_SAIL_EPIC_LAST5_YEARS,'N') AS EVER_SAILED_EPIC_LAST5_YEARS
,nvl(EVER_BOOKED_ESCAPE_LAST5_YEARS,'N') AS EVER_BOOKED_ESCAPE_LAST5_YEARS
,nvl(EVER_SAIL_ESCAPE_LAST5_YEARS,'N') AS EVER_SAILED_ESCAPE_LAST5_YEARS
,nvl(EVER_BOOKED_GEM_LAST5_YEARS,'N') AS EVER_BOOKED_GEM_LAST5_YEARS
,nvl(EVER_SAIL_GEM_LAST5_YEARS,'N') AS EVER_SAILED_GEM_LAST5_YEARS
,nvl(EVER_BOOKED_GETAWAY_LAST5_YEARS,'N') AS EVER_BOOKED_GETAWAY_LAST5_YEARS
,nvl(EVER_SAIL_GETAWAY_LAST5_YEARS,'N') AS EVER_SAILED_GETAWAY_LAST5_YEARS
,nvl(EVER_BOOKED_JADE_LAST5_YEARS,'N') AS EVER_BOOKED_JADE_LAST5_YEARS
,nvl(EVER_SAIL_JADE_LAST5_YEARS,'N') AS EVER_SAILED_JADE_LAST5_YEARS
,nvl(EVER_BOOKED_JEWEL_LAST5_YEARS,'N') AS EVER_BOOKED_JEWEL_LAST5_YEARS
,nvl(EVER_SAIL_JEWEL_LAST5_YEARS,'N') AS EVER_SAILED_JEWEL_LAST5_YEARS
,nvl(EVER_BOOKED_PEARL_LAST5_YEARS,'N') AS EVER_BOOKED_PEARL_LAST5_YEARS
,nvl(EVER_SAIL_PEARL_LAST5_YEARS,'N') AS EVER_SAILED_PEARL_LAST5_YEARS
,nvl(EVER_BOOKED_SPIRIT_LAST5_YEARS,'N') AS EVER_BOOKED_SPIRIT_LAST5_YEARS
,nvl(EVER_SAIL_SPIRIT_LAST5_YEARS,'N') AS EVER_SAILED_SPIRIT_LAST5_YEARS
,nvl(EVER_BOOKED_STAR_LAST5_YEARS,'N') AS EVER_BOOKED_STAR_LAST5_YEARS
,nvl(EVER_SAIL_STAR_LAST5_YEARS,'N') AS EVER_SAILED_STAR_LAST5_YEARS
,nvl(EVER_SAIL_ALASKA_LAST5_YEARS,'N') AS EVER_SAILED_ALASKA_LAST5_YEARS
,nvl(EVER_SAIL_BAHAMAS_LAST5_YEARS,'N') AS EVER_SAILED_BAHAMAS_LAST5_YEARS
,nvl(EVER_SAIL_BERMUDA_LAST5_YEARS,'N') AS EVER_SAILED_BERMUDA_LAST5_YEARS
,nvl(EVER_SAIL_CANENG_IND_LAST5_YEARS,'N') AS EVER_SAIL_CANENG_IND_LAST5_YEARS
,nvl(EVER_SAIL_CARIBBEAN_LAST5_YEARS,'N') AS EVER_SAILED_CARIBBEAN_LAST5_YEARS
,nvl(EVER_SAIL_CUBA_LAST5_YEARS,'N') AS EVER_SAILED_CUBA_LAST5_YEARS
,nvl(EVER_SAIL_EUROPE_LAST5_YEARS,'N') AS EVER_SAILED_EUROPE_LAST5_YEARS
,nvl(EVER_SAIL_HAWAII_LAST5_YEARS,'N') AS EVER_SAILED_HAWAII_LAST5_YEARS
,nvl(EVER_SAIL_MEXICAN_RIVIERA_LAST5_YEARS,'N') AS EVER_SAILED_MEXICAN_RIVIERA_LAST5_YEARS
,nvl(EVER_SAIL_MIAMI_LAST5_YEARS,'N') AS EVER_SAILED_MIAMI_LAST5_YEARS
,nvl(EVER_SAIL_SOUTH_AMERICA_LAST5_YEARS,'N') AS EVER_SAILED_SOUTH_AMERICA_LAST5_YEARS
,nvl(EVER_SAIL_REPOSITION_LAST5_YEARS,'N') AS EVER_SAIL_REPOSITION_LAST5_YEARS
,'N'AS  EVER_SAIL_HOLIDAY_LAST5_YEARS
,nvl(EVER_SAIL_INSIDE_LAST5_YEARS,'N') AS EVER_SAIL_INSIDE_LAST5_YEARS
,nvl(EVER_SAIL_OUTSIDE_LAST5_YEARS,'N') AS EVER_SAIL_OUTSIDE_LAST5_YEARS
,nvl(EVER_SAIL_HAVEN_LAST5_YEARS,'N') AS EVER_SAIL_HAVEN_LAST5_YEARS
,nvl(EVER_SAIL_BALCONY_LAST5_YEARS,'N') AS EVER_SAIL_BALCONY_LAST5_YEARS
,nvl(EVER_SAIL_MINISUITE_LAST5_YEARS,'N') AS EVER_SAIL_MINISUITE_LAST5_YEARS
,nvl(EVER_SAIL_ONETWO_LAST5_YEARS,'N') AS EVER_SAIL_ONETWO_LAST5_YEARS
,nvl(EVER_SAIL_SUITE_LAST5_YEARS,'N') AS EVER_SAIL_SUITE_LAST5_YEARS
,nvl(EVER_SAIL_STUDIO_LAST5_YEARS,'N') AS EVER_SAIL_STUDIO_LAST5_YEARS
,nvl(EVER_SAIL_JOY_CONCIERGE_LAST5_YEARS,'N') AS EVER_SAIL_JOY_CONCIERGE_LAST5_YEARS
,nvl(BOOKING_CURVE_SEGMENT,'N') AS BOOKING_CURVE_SEGMENT
,nvl(CUSTOMER_SEGMENT,'N') AS CUSTOMER_SEGMENT
,nvl(IS_FUTURE_BOOKED_CD,'N') AS IS_FUTURE_BOOKED_CD
,nvl(SALES_CHANNEL_CD,'N') AS SALES_CHANNEL_CD
,nvl(IS_PCC_CD,'N') AS IS_PCC_CD
,'N'AS IS_DRIVE_PORT_CD
,nvl(IS_OBC_CD,'N') AS IS_OBC_CD
,nvl(IS_DINING_PACKAGE_CD,'N') AS IS_DINING_PACKAGE_CD
,nvl(IS_DINING_CREDIT_CD,'N') AS IS_DINING_CREDIT_CD
,nvl(IS_BEVERAGE_CD,'N') AS IS_BEVERAGE_CD
,nvl(IS_SODA_CD,'N') AS IS_SODA_CD
,nvl(IS_SERVICE_CHARGES_CD,'N') AS IS_SERVICE_CHARGES_CD
,nvl(IS_AIR_CREDIT_CD,'N') AS IS_AIR_CREDIT_CD
,nvl(IS_SHOREX_CD,'N') AS IS_SHOREX_CD
,nvl(IS_INTERNET_CD,'N') AS IS_INTERNET_CD
,nvl(IS_FREE_HOTEL_CD,'N') AS IS_FREE_HOTEL_CD
,nvl(FAMILY_FLAG,'N') AS FAMILY_FLAG
,nvl(IS_PHOTOS_CD,'N') AS IS_PHOTOS_CD
,nvl(IS_ARCADE_CREDIT_CD,'N') AS IS_ARCADE_CREDIT_CD
,nvl(IS_CASINO_CREDIT_CD,'N') AS IS_CASINO_CREDIT
,nvl(IS_THIRD_FOURTH_GUEST_FREE_CD,'N') AS IS_THIRD_FOURTH_GUEST_FREE_CD
,nvl(IS_THIRD_FOURTH_GUEST_99_USD_CD,'N') AS IS_THIRD_FOURTH_GUEST_99_USD_CD
,nvl(REGION_NAM,'N') AS REGION_NAM
,nvl(LOYALTY_LEVEL,'N') AS LOYALTY_LEVEL
,nvl(SAIL_TOTAL_CRUISES_CNT,0.00) AS SAIL_TOTAL_CRUISES_CNT
,nvl(LAST_SAIL_BOOKING_CHANNEL,'N') AS LAST_SAIL_BOOKING_CHANNEL
,nvl(COMPETING_CRUISER_GSS,0.00) AS COMPETING_CRUISER_GSS
,nvl(SAIL_RECENCY_SEGMENT,'N') AS SAIL_RECENCY_SEGMENT
,nvl(GENERATION_SEGMENT,'N') AS GENERATION_SEGMENT
,nvl(TARGET_NARROW_BAND_INCOME,'') as TARGET_NARROW_BAND_INCOME 
,nvl(CRUISE_NEXT_COUNT,0.0) AS CRUISE_NEXT_COUNT
,nvl(BG_7_120_Days_sail_Hawaii,'N') AS BG_7_120_Days_sail_Hawaii
,nvl(BG_121_180_Days_sail_Hawaii,'N') AS BG_121_180_Days_sail_Hawaii
,nvl(BG_7_120_Days_sail_Western_Caribbean,'N') AS BG_7_120_Days_sail_Western_Caribbean
,nvl(BG_121_180_Days_sail_Western_Caribbean,'N') AS BG_121_180_Days_sail_Western_Caribbean
,nvl(BG_7_120_Days_sail_Eestern_Caribbean,'N') AS BG_7_120_Days_sail_Eastern_Caribbean
,nvl(BG_121_180_Days_sail_Eestern_Caribbean,'N') AS BG_121_180_Days_sail_Eastern_Caribbean
,nvl(BG_7_120_Days_sail_Europe_Mediterranean,'N') AS BG_7_120_Days_sail_Europe_Mediterranean
,nvl(BG_121_180_Days_sail_Europe_Mediterranean,'N') AS BG_121_180_Days_sail_Europe_Mediterranean
,nvl(BG_7_120_Days_sail_Europe_Baltic,'N') AS BG_7_120_Days_sail_Europe_Baltic
,nvl(BG_121_180_Days_sail_Europe_Baltic,'N') AS BG_121_180_Days_sail_Europe_Baltic
,nvl(BG_7_120_Days_sail_Europe_Northern,'N') AS BG_7_120_Days_sail_Europe_Northern
,nvl(BG_121_180_Days_sail_Europe_Northern,'N') AS BG_121_180_Days_sail_Europe_Northern
,nvl(BG_7_120_Days_sail_Alaska,'N') AS BG_7_120_Days_sail_Alaska
,nvl(BG_121_180_Days_sail_Alaska,'N') AS BG_121_180_Days_sail_Alaska

FROM CDP_D.CDP_STG.FIRST_32_COLUMNS_US A
LEFT OUTER JOIN CDP_D.CDP_STG.BOOKED_LAST_5_YEARS_US B
ON A.CONTACT_ID = B.CONTACT_ID 
LEFT OUTER JOIN CDP_D.CDP_STG.SAILED_LAST_5_YEARS_US C
ON A.CONTACT_ID = C.CONTACT_ID
LEFT OUTER JOIN CDP_D.CDP_STG.COLUMN_126_ONWARDS_US D
ON A.CONTACT_ID = D.CONTACT_ID
LEFT OUTER JOIN CDP_D.CDP_STG.PROMO_CD_US E
ON A.CONTACT_ID = E.CONTACT_ID
LEFT OUTER JOIN CDP_D.APP_CDP.DIM_CLIENT CLIENT
ON A.CONTACT_ID = CLIENT.CONTACT_ID
WHERE UPPER(TRIM(A.SALES_CHANNEL_CD)) = UPPER(TRIM('CASINO')) AND
 UPPER(TRIM(CLIENT.CLIENT_CLASS_CD)) NOT IN ('DECEASED','SUPPRESS MKT PROMOS')
AND CLIENT.CLIENT_ID IS NOT NULL
AND TRIM(CLIENT.PROMOTION_SELECTION_TXT) IS NULL
